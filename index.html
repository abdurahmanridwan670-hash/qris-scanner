<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QRIS Scanner</title>

  <style>
    :root{ --orange:#da3c3e; --bg:#f2efed; --header:#fff0e6; }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:#2b2b2b; font-family:Arial, Helvetica, sans-serif;
      min-height:100dvh; display:grid; place-items:center; overflow:hidden;
    }
    .center{display:grid; gap:18px; width:100%; max-width:1400px; padding:16px}
    .page-title{margin:0; text-align:center; color:var(--orange); font-weight:900; font-size:44px}
    .card{
      background:#fff; border-radius:22px; width:100%;
      padding:28px; box-shadow:0 14px 36px rgba(0,0,0,.13);
      max-height:calc(100dvh - 160px); overflow:auto; scrollbar-gutter:stable both-edges;
    }

    .uploader{display:flex; align-items:center; justify-content:center; gap:16px; margin-top:6px; flex-wrap:wrap}
    #fileInput{display:none}

    /* kotak besar untuk drag-drop */
    .dropzone{
      display:flex; align-items:center; justify-content:center; text-align:center;
      font-weight:800; font-size:20px; color:var(--orange);
      background:#fff; cursor:pointer; border:2px dashed var(--orange); border-radius:16px;
      width:min(100%, 980px); height:180px;  /* <<< lebih besar */
      padding:16px 22px; margin-inline:auto;
      transition:background .2s ease, transform .1s ease;
    }
    .dropzone.drag{ background:var(--header); transform:scale(1.01); }

    .btn{ /* tidak terpakai saat ini, disisakan jika nanti butuh tombol lain */
      border:2px solid var(--orange); color:#fff; background:var(--orange);
      padding:14px 18px; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer;
    }
    .btn.secondary{ background:#fff; color:var(--orange); border-style:dashed }
    .btn:disabled{filter:grayscale(.6) opacity(.7); cursor:not-allowed}

    .hint{font-size:12px; color:#6b7280; text-align:center; margin-top:8px}
    .kbd{padding:2px 6px;border:1px solid #ddd;border-bottom-width:2px;border-radius:6px;background:#fafafa;font-family:ui-monospace,monospace}

    table{width:100%; border-collapse:collapse; margin-top:22px; table-layout:fixed}
    th,td{padding:14px 16px; border-bottom:1px solid #eee; text-align:left; vertical-align:top}
    th{background:var(--header); color:var(--orange); font-size:18px; font-weight:800}
    td{font-size:16px; line-height:1.6}
    .raw{white-space:normal; word-break:break-all}

    .small{font-size:14px; color:#6b7280; text-align:center}
    .alert{display:none; margin:16px auto 0; max-width:840px; padding:12px 16px;
      border:1px solid #f5b2a2; background:#fff7f2; color:#8c2a15; border-radius:10px; text-align:center; font-weight:700}
  </style>

  <!-- jsQR untuk decoding QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <div class="center">
    <h1 class="page-title">QRIS SCANNER</h1>

    <div class="card">
      <div class="uploader" id="uploader">
        <label class="dropzone" for="fileInput" id="dropzone">Upload/Drag image/Paste</label>
        <input id="fileInput" type="file" accept="image/*" />
      </div>
      <div class="hint" id="osHint"></div>

      <table id="resultTable" style="display:none">
        <thead>
          <tr>
            <th>Nama Merchant</th>
            <th>Penyedia/Bank</th>
            <th>NMID</th>
            <th>Category</th>
            <th>Raw data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p id="status" class="small"></p>
      <p id="err" class="alert"></p>
    </div>
  </div>

<script>
/* ====== Helper DOM ====== */
const $ = id => document.getElementById(id);
const fileInput = $('fileInput');
const table = $('resultTable');
const tbody = table.querySelector('tbody');
const statusEl = $('status');
const errEl = $('err');
const dz = $('dropzone');
const osHint = $('osHint');

/* ====== OS hint (untuk paste) ====== */
(() => {
  const isMac = navigator.platform.toLowerCase().includes('mac');
  osHint.innerHTML = isMac
    ? `Tips: kamu bisa paste langsung dari clipboard (mis. <span class="kbd">Shift</span>+<span class="kbd">Cmd</span>+<span class="kbd">4</span> lalu <b>Cmd+V</b> di sini).`
    : `Tips: kamu bisa paste langsung dari clipboard (mis. <span class="kbd">Win</span>+<span class="kbd">Shift</span>+<span class="kbd">S</span> lalu <b>Ctrl+V</b> di sini).`;
})();

/* ====== Upload & drag/drop & paste ====== */
fileInput.addEventListener('change', () => {
  const f = fileInput.files[0];
  if (f) handleBlobAsFile(f, f.name || 'upload.png');
});

['dragenter','dragover'].forEach(ev =>
  document.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); })
);
['dragleave','drop'].forEach(ev =>
  document.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); })
);

document.addEventListener('drop', e => {
  const f = e.dataTransfer?.files?.[0];
  if (f) handleBlobAsFile(f, f.name || 'drop.png');
});

window.addEventListener('paste', e => {
  const items = e.clipboardData?.items || [];
  for (const it of items) {
    if (it.type?.startsWith('image/')) {
      const blob = it.getAsFile();
      if (blob) handleBlobAsFile(blob, 'clipboard.png');
      e.preventDefault(); return;
    }
  }
});

/* ====== Pipeline utama ====== */
async function handleBlobAsFile(blob, filename) {
  try {
    const file = new File([blob], filename, { type: blob.type || 'image/png' });
    await handleFile(file);
  } catch(e) {
    showError(e?.message || 'Gagal memproses gambar.');
  }
}

async function handleFile(file){
  tbody.innerHTML=''; table.style.display='none';
  hideError(); statusEl.textContent='Memindai QR...';
  try{
    const text = await decodeQRFromImage(file);
    if(!text) throw new Error('QR tidak terbaca / tidak ditemukan.');
    const emv = parseEMV(text);
    const row = simplifyQRIS(emv, text);
    appendRow(row);
    table.style.display = '';
    statusEl.textContent = '';
  }catch(e){ statusEl.textContent = ''; showError(e.message || 'QR tidak terbaca.'); }
}

function appendRow(row){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${esc(row.merchantName||'-')}</td>
    <td>${esc(row.provider||'-')}</td>
    <td>${esc(row.mid||'-')}</td>
    <td>${esc(row.category||'-')}</td>
    <td class="raw">${esc(row.rawShort||'-')}</td>`;
  tbody.appendChild(tr);
}

/* ====== Utils ====== */
function esc(s){ const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }; return String(s ?? '').replace(/[&<>"']/g, ch => map[ch]); }
function showError(msg){ errEl.textContent = msg; errEl.style.display = 'block'; }
function hideError(){ errEl.style.display = 'none'; errEl.textContent = ''; }

/* ====== jsQR decode (multi-scale agar lebih robust) ====== */
async function decodeQRFromImage(file){
  const bmp = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  // beberapa skala: asli, mengecil & sedikit membesar
  const scales = [1, 0.75, 0.5, 1.25, 1.5];

  for (const s of scales) {
    const w = Math.max(30, Math.round(bmp.width * s));
    const h = Math.max(30, Math.round(bmp.height * s));
    canvas.width = w; canvas.height = h;
    ctx.clearRect(0,0,w,h);
    ctx.drawImage(bmp, 0, 0, w, h);

    const data = ctx.getImageData(0, 0, w, h);
    const code = jsQR(data.data, data.width, data.height);

    if (code && code.data) {
      return code.data.trim();
    }
  }
  return '';
}

/* ====== EMV/QRIS parsing ringkas ====== */
function parseTLV(s){ const out={}; let i=0; while(i+4<=s.length){ const id=s.slice(i,i+2); i+=2; const len=parseInt(s.slice(i,i+2),10); i+=2; out[id]=s.slice(i,i+len); i+=len; } return out; }
function parseEMV(raw){ const tlv=parseTLV(raw), mais=[]; for(let id=26; id<=51; id++){ const k=String(id).padStart(2,'0'); if(tlv[k]) mais.push({id:k, tlv:parseTLV(tlv[k])}); } return {tlv, mais, raw}; }

const STOPWORDS=new Set(['qris','www','id','co','com','pay','payment','merchant','account','qr','indo','indonesia']);
function extractProviderName(emv){
  let best=''; const score=s=>{ const t=(s||'').trim(); if(!t) return 0; const L=(t.match(/[A-Za-z]/g)||[]).length; const D=(t.match(/[0-9]/g)||[]).length; return L-D*2+Math.min(L,12); };
  for(const mai of emv.mais){
    const m=mai.tlv, gui=m['00']||'', brand=deriveFromGUI(gui);
    if(brand && score(brand)>score(best)) best=brand;
    for(const k in m){ if(k==='00'||k==='01') continue; const cleaned=cleanupName(m[k]); if(!cleaned) continue; if(brand && cleaned.length<=3) continue; if(score(cleaned)>score(best)+1) best=cleaned; }
  }
  return best||'(tidak diketahui)';
}
function cleanupName(val){
  let s=String(val||'').replace(/[_-]/g,' ').replace(/\s+/g,' ').trim();
  s=s.replace(/(NMID|MID)[:\s-]*[A-Za-z0-9\-]+/ig,'').replace(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+/g,'').replace(/https?:[^\s]+/g,'').replace(/[0-9]{4,}/g,'');
  const tokens=s.split(/[^A-Za-z]+/).filter(Boolean).map(t=>t.toLowerCase()).filter(t=>!STOPWORDS.has(t));
  return tokens.length?tokens.slice(0,3).map(titleCase).join(' '):'';
}
function deriveFromGUI(gui){
  const g=String(gui||'').trim(); if(!g) return '';
  let host=''; try{ const u=new URL(/^https?:\/\//i.test(g)?g:'https://'+g); host=u.hostname; } catch{ host=g.replace(/^[A-Za-z]+:\/\//,'').split('/')[0]; }
  const parts=host.split('.').filter(Boolean).filter(p=>!['id','co','com','www','qris'].includes(p.toLowerCase()));
  if(!parts.length) return ''; let best=''; for(const p of parts){ const L=(p.match(/[A-Za-z]/g)||[]).length; if(L>((best.match?.(/[A-Za-z]/g)||[]).length||0)) best=p; }
  const name=(best||'').replace(/[^A-Za-z]/g,''); return name?(name.length<=4?name.toUpperCase():titleCase(name)):'';
}
function titleCase(s){ return String(s||'').toLowerCase().replace(/\b([a-z])/g,m=>m.toUpperCase()); }
function extractMID(emv){
  const RE=/ID[0-9]{6,}/;
  for(const mai of emv.mais){
    const m=mai.tlv||{};
    for(const k in m){
      const v=String(m[k]||'');
      const hit=v.match(RE);
      if(hit?.[0]) return hit[0];
    }
  }
  for(const mai of emv.mais){
    const mid01=mai.tlv && mai.tlv['01']? String(mai.tlv['01']).trim():'';
    if (mid01) return mid01;
  }
  return '';
}
function simplifyQRIS(emv, raw){
  const merchantName=emv.tlv['59']||'';
  const provider=extractProviderName(emv);
  const mid=extractMID(emv);
  const category=provider.toLowerCase().includes('shopee')?'On-Us':'Off-Us';
  const rawShort=raw;
  return { merchantName, provider, mid, category, rawShort };
}

/* Error global ke UI */
window.addEventListener('error', e => { showError('Error: ' + (e.message||e)); });
</script>
</body>
</html>
